# BRIEF: servAI — AI‑платформа для управления многоквартирными комплексами (MVP‑срез)

## 1. Общее описание продукта

servAI — SaaS‑платформа для управляющих компаний (УК) и жилых комплексов (ЖК), в которой жители, сотрудники и администрация взаимодействуют через AI‑помощника в Telegram и веб‑админ‑панель. [web:1]

Технологический стек:
- Бэкенд: Node.js + Express, PostgreSQL, очереди (BullMQ).
- Фронтенд админ‑панели: Vue 3 + Quasar.
- Хостинг: всё в Docker (backend, frontend, worker, БД). [conversation_history:0]

AI:
- Обработка естественного языка и изображений — через Perplexity Sonar API (search‑first модель). [web:1]

Интеграции:
- Telegram — единый бот для всей платформы.
- Stripe — платежи жителей, webhooks.
- Perplexity Sonar — NLU и генерация ответов. [web:1]

Данные разных УК логически изолированы (multi‑tenant, общий кластер БД с company_id/tenant_id в ключевых таблицах). [conversation_history:0]

---

## 2. MVP‑срез: что входит в первую версию

### 2.1. Входит в MVP

Telegram‑бот:
- Житель:
  - Естественный диалог.
  - Передача показаний (текст + фото).
  - История показаний.
  - Создание обращений и комментариев.
  - Просмотр списка обращений и статусов.
  - Получение уведомлений о счетах и ссылок на оплату.
  - Просмотр истории счетов и платежей (минимальный список/детали). [conversation_history:0]
- Сотрудник:
  - Авторизация через invite/роль.
  - Список своих задач (обращений).
  - Просмотр карточки задачи.
  - Смена статусов (в работе, проверка, решено).
  - Комментарии, прикрепление фото. [conversation_history:0]

Админ‑панель:
- Директор УК:
  - Просмотр ЖК и объектов.
  - Базовый дашборд по обращениям и платежам.
  - Управление тарифами на уровне ЖК (через экран ЖК).
  - Просмотр счетов и статуса оплаты УК. [conversation_history:0]
- Администратор ЖК:
  - Импорт объектов (Excel).
  - Список объектов.
  - Очередь обращений, ручное назначение/переназначение.
  - Просмотр показаний и отклонений.
  - Управление приглашениями жителей.
- Бухгалтер УК:
  - Просмотр начислений и оплат по ЖК и объектам.
  - Загрузка/просмотр счетов. [conversation_history:0]
- Супер‑админ:
  - Создание/редактирование УК.
  - Настройки платформы (тарифы, системный AI‑промпт).
- Супер‑бухгалтер:
  - Управление счетами для УК (формирование, подтверждение оплаты, блокировка/разблокировка УК). [conversation_history:0]

Интеграции и фоновые задачи:
- Telegram:
  - Приём всех типов сообщений (text, photo, callback_query).
  - Очередь обработки входящих сообщений.
- Perplexity Sonar:
  - NLU (интент + параметры).
  - Генерация естественных ответов с учётом контекста. [web:1]
- Stripe:
  - Приём оплат жителей.
  - Webhooks успешных и неуспешных платежей. [web:16]
- BullMQ:
  - Импорт Excel.
  - Генерация счетов (жители, УК).
  - Рассылка массовых уведомлений (с учётом лимитов Telegram). [conversation_history:0]

Отчётность:
- Для директора УК и администратора ЖК:
  - Минимальные отчёты: реестр объектов с начислениями и платежами, задолженности, базовая статистика обращений.
- Авторассылка отчётов 1 числа каждого месяца (PDF + Excel). [conversation_history:0]

### 2.2. Можно отложить (вне MVP, но описано в системе)

Эти блоки проектируются в архитектуре, но их реализация может быть перенесена на следующие релизы:

- Опросы и голосования (Polls).
- Контроль въезда/ворота (номера авто, охрана).
- Передача ЖК между УК.
- Расширенные дашборды (рейтинги сотрудников, углублённая аналитика).
- Демо‑режим с продвинутой симуляцией событий. [conversation_history:0]

---

## 3. Роли, иерархия и контексты

### 3.1. Иерархия

- Платформа:
  - Супер‑админ.
  - Супер‑бухгалтер.
- Управляющая компания (УК):
  - Директор УК.
  - Бухгалтер УК.
- Жилой комплекс (ЖК):
  - Администратор ЖК.
  - Сотрудники ЖК (исполнители: сантехник, электрик, уборщик, садовник, охранник и т.п.).
- Жители:
  - Владельцы/арендаторы, привязанные к объектам (квартирам и помещениям). [conversation_history:0]

Структура:
- Одна УК имеет один или несколько ЖК.
- ЖК принадлежит только одной УК.
- ЖК может быть передан другой УК (функция за пределами MVP). [conversation_history:0]

### 3.2. Роли и много‑контекстность

Пользователь может иметь несколько ролей в разных контекстах:
- Житель нескольких объектов (в одной или разных УК/ЖК).
- Сотрудник в нескольких ЖК/УК.
- Теоретически — директор одной УК и сотрудник другой (разрешено). [conversation_history:0]

Для этого:
- Вводится таблица user_roles (user_id, company_id, condo_id, role, staff_profile_id?).
- При входе в админ‑панель пользователь выбирает активный контекст (УК/ЖК), если их несколько.
- В токен/контекст backend‑запроса попадает текущий выбранный контекст, и все запросы фильтруются по нему. [conversation_history:0]

---

## 4. Telegram‑бот и AI‑логика (MVP)

### 4.1. Общие принципы

- Один Telegram‑бот для всей платформы (webhook или polling — конфиг деплоя). [web:15]
- Бот работает с жителями и сотрудниками.
- Язык ответа — язык пользователя из Telegram (locale), без ручного выбора.
- Весь диалог пользователя хранится в БД (сообщения, метки интентов, служебные данные). [conversation_history:0]

### 4.2. Интеграция с Perplexity Sonar

В рамках MVP:

- При каждом входящем сообщении:
  - Берутся последние N=20 сообщений диалога + сохранённое summary пользователя (краткое резюме контекста).
  - К Sonar отправляется:
    - системный промпт (редактируется через админку платформы);
    - история диалога;
    - текущий запрос. [web:1]
- Модель Sonar должна возвращать структурированный ответ:
  - интент (идентификатор из списка интентов платформы);
  - параметры (извлечённые поля — тип счётчика, значение, объект, тип обращения и т.д.);
  - обновлённое summary пользователя (краткая выжимка истории для будущих запросов). [conversation_history:0]

Обработка ошибок:
- При временных ошибках/таймаутах Sonar:
  - до 1–2 повторов через очередь;
  - если повторно неудачно — бот отвечает, что в данный момент не может обработать запрос, и предлагает попробовать позже.

### 4.3. Очередь сообщений и exponential delay

Для защиты от флуда и экономии квоты Sonar: [conversation_history:0]

- Все входящие сообщения ставятся в очередь.
- Для каждого пользователя рассчитывается число сообщений за последние 60 минут.
- Задержка перед обработкой нового сообщения растёт **экспоненциально** от количества последних сообщений (например, базовый delay * 2^k, где k — превышение порога).
- Сообщение лежит в очереди до начала обработки; фактическая отправка запроса к Sonar происходит уже после задержки.
- Настройки порогов и максимальной задержки задаются конфигом (ENV/настройки платформы).

### 4.4. Разрешение неоднозначностей

Если AI не уверен и предлагает несколько вариантов (например, несколько квартир или несколько типов счётчиков), бот обязан:
- Явно вывести пользователю варианты.
- Попросить выбрать нужный. [conversation_history:0]

Никаких автодогадок без подтверждения, если у пользователя несколько возможных объектов/контекстов.

---

## 5. Объекты (ЖК, корпуса, подъезды, квартиры/помещения)

### 5.1. Структура

- УК.
- ЖК:
  - Несколько корпусов (building).
  - В каждом корпусе — несколько подъездов (entrance).
- Объекты (units):
  - Жилые квартиры.
  - Коммерческие помещения.
  - Тип (жилое/нежилое/коммерческое/паркинг и т.п.) — настраиваемый справочник. [conversation_history:0]

Нумерация:
- Номер квартиры уникален в рамках корпуса.
- Подъезды — строка (цифры/буквы).
- Адрес объекта: страна, город, улица, дом, корпус, подъезд, номер, этаж.

### 5.2. Импорт объектов (MVP)

Импорт через Excel обязателен в MVP:
- Формат:
  - Файл Excel (XLSX/XLS) загружается через админ‑панель ЖК.
- Обязательные поля:
  - Корпус.
  - Подъезд (может быть пустым для отдельных коммерческих помещений).
  - Номер объекта.
  - Этаж.
  - Площадь (>0, дробные допустимы, разделители «.» и «,»).
  - Тип объекта. [conversation_history:0]
- Маппинг столбцов:
  - Система пытается автоматически распознать столбцы по заголовкам.
  - Администратор может вручную сопоставить столбцы.
- Выполнение:
  - Импорт асинхронный, через очередь.
  - Ошибка в строке не блокирует общий импорт — для ошибок формируется отдельный отчёт.
  - Повторный импорт обновляет существующие записи (по ключу корпус+подъезд+номер).

---

## 6. Жители и приглашения (MVP)

### 6.1. Приглашения (invites)

- Жители регистрируются только через invite‑ссылку, привязанную к объекту.
- Invite:
  - Многоразовый (несколько жителей на один объект).
  - По умолчанию — максимум 1 активный invite на объект (опционально настраиваемый лимит).
  - Срок жизни — 7 дней. [conversation_history:0]
- Управление:
  - Создание и отзыв через админ‑панель ЖК/УК.

### 6.2. Привязка жителя к объекту

При переходе по invite в Telegram:
- Бот связывает Telegram user с unit.
- Если у жителя только один unit — он автоматически активен в диалоге.
- Если несколько unit — AI определяет по содержанию, к какому относится запрос; при неуверенности бот предлагает список объектов на выбор. [conversation_history:0]

---

## 7. Обращения (тикеты) — MVP

### 7.1. Создание (житель/сотрудник)

Житель:
- Пишет проблему естественным текстом (с фото/файлами при необходимости).
- AI:
  - Определяет категорию (настраиваемый справочник категорий).
  - Привязывает к unit.
  - Создаёт тикет со статусом NEW.

Сотрудник:
- Может создать тикет (например, охранник или дворник фиксирует проблему) — через бота. [conversation_history:0]

### 7.2. Статусы и жизненный цикл (MVP)

Статусы:
- NEW (новое).
- ASSIGNED (назначено).
- IN_PROGRESS (в работе).
- REVIEW (проверка).
- RESOLVED (решено).
- CLOSED (закрыто). [conversation_history:0]

Логика:
- NEW → AI пытается назначить исполнителя по категории и специализации.
- При успешном автоназначении:
  - тикет → ASSIGNED;
  - исполнитель получает уведомление в боте.
- Исполнитель:
  - берёт в работу → IN_PROGRESS;
  - завершает → REVIEW → RESOLVED.
- После RESOLVED:
  - Жителю отправляется запрос оценить работу (1–5).
  - Через 24 часа тикет автоматически переходит в CLOSED, даже без оценки. [conversation_history:0]

Житель:
- Может просматривать тикеты и их статусы.
- Может комментировать своё обращение.
- Получает уведомления:
  - при назначении;
  - при смене статусов;
  - при новых комментариях;
  - при запросе оценки. [conversation_history:0]

Оценки:
- 1–5, необязательны (можно пропустить).
- Видны:
  - сотруднику (его рейтинг);
  - админу ЖК;
  - директору УК.
- Не влияют на автоназначение в MVP.

---

## 8. Показания счётчиков — MVP

### 8.1. Типы счётчиков

- Системные по умолчанию:
  - Холодная вода.
  - Электричество.
- УК/ЖК может добавлять свои типы счётчиков.
- Поддержка многотарифных счётчиков (например, день/ночь). [conversation_history:0]

### 8.2. Ввод показаний

Житель:
- Пишет текстом (например, «холодная 12.5, свет 1234»).
- Или отправляет фото счётчика.

AI:
- Извлекает тип счётчика и значение из текста.
- При фото — Sonar распознаёт показатель:
  - При неудаче:
    - первый раз — бот просит переснять;
    - второй раз — снова просит переснять;
    - если дважды не удалось — предлагается ручной ввод.
  - При успехе — бот показывает распознанное значение, просит подтвердить. [conversation_history:0][web:1]

Валидация (на уровне ЖК):
- Новое показание >= предыдущего.
- Допустимый прирост за месяц по каждому типу.
- Значение > 0, дробные допускаются.
- При невалидности:
  - просим ввести заново;
  - если дважды введено одно и то же значение — принимаем, помечая как принудительное принятие. [conversation_history:0]

История:
- Житель видит историю своих показаний.
- УК/ЖК видит показания и фото (фото хранится в уменьшенном виде).

---

## 9. Тарифы, счета, платежи — MVP

### 9.1. Тарифы ЖК

Настройки на уровне ЖК:
- Виды услуг:
  - по показаниям счётчиков;
  - по площади (за кв. м);
  - фиксированные платежи. [conversation_history:0]
- Разные тарифы для разных типов объектов (жилое/коммерческое).
- Тариф положителен, до 6 знаков после запятой.

Логика при отсутствии показаний:
- Настраивается на уровне тарифа ЖК (по среднему/предыдущему/нормативу и т.п.).

### 9.2. Счета и Stripe

Житель:
- 1 числа получает сообщение в Telegram: «Ваш счёт готов».
- По запросу — получает PDF‑счёт.
- Оплата:
  - через Stripe Payment Link;
  - частичная оплата разрешена. [web:16]
- Может запросить историю своих платежей. [conversation_history:0]

Платформа:
- Начисления по объекту — на основе показаний, площади и фиксированных услуг.
- Комиссия платформы:
  - фикс + процент, задаются в настройках (платформы/УК).
  - удерживаются при обработке платежа.

### 9.3. Счета для УК

1 числа:
- Формируется счёт для УК:
  - суммарные начисления/оплаты;
  - комиссия платформы;
  - итог к оплате/выплате. [conversation_history:0]
- PDF отправляется директору/бухгалтеру УК по email и доступен в админке.

Блокировка:
- Grace‑период 5 рабочих дней.
- На 6‑й рабочий день, если супер‑бухгалтер не подтвердил оплату:
  - УК блокируется;
  - в админ‑панели доступен только личный кабинет и страница счетов;
  - бот отвечает жителям, что УК не оплатила задолженность. [conversation_history:0]

---

## 10. Очереди и фоновые задачи — MVP

Используем очереди для: [conversation_history:0]

- Импорт Excel объектов и показаний.
- Обработку входящих сообщений (Telegram → Sonar → бизнес‑логика).
- Генерацию счетов (жители, УК).
- Рассылку массовых уведомлений:
  - напоминания о показаниях;
  - напоминания об оплатах;
  - системные уведомления.

Cron‑задачи:
- 1 число месяца:
  - формирование счетов для жителей;
  - формирование и отправка счетов УК;
  - генерация и рассылка ежемесячных отчётов. [conversation_history:0]
- Ежедневно:
  - очистка устаревших invites (старше 7 дней);
  - очистка audit‑логов старше 3 месяцев;
  - очистка файлов старше 1 года (кроме счетов, если предусмотрен более длительный срок).

Требования:
- Идемпотентность задач.
- Авто‑ретраи и отсутствие «зависших» задач по дизайну (без ручного перезапуска через UI).

---

## 11. Безопасность, логирование и окружения — MVP

### 11.1. Аутентификация

- JWT (Bearer):
  - срок жизни токена — 1 неделя;
  - автоматическое обновление (рефреш логика на backend, без отдельного refresh токена наружу).
- 2FA по email:
  - опционально для аккаунта. [conversation_history:0]

Пароли:
- Минимальная длина и сложность.
- Смена по расписанию и история паролей — не обязательны в MVP.

### 11.2. GDPR и данные

- Согласие на обработку данных:
  - показывается при первом запуске бота;
  - продолжение использования = согласие. [conversation_history:0]
- Логи:
  - хранятся минимум 3 месяца.
- Файлы:
  - фото/вложения — удаляются через 1 год;
  - PDF счетов для УК — до 3 лет. [conversation_history:0]

### 11.3. Логирование и мониторинг (минимум)

Логируем:
- HTTP‑запросы (без чувствительных данных).
- Ошибки (с stacktrace).
- Ключевые бизнес‑события:
  - создание обращения;
  - передача показаний;
  - оплата;
  - блокировка/разблокировка УК. [conversation_history:0]

Метрики:
- Количество запросов к Sonar/час.
- Количество ошибок интеграций (Stripe, Telegram, Sonar).
- Количество входящих сообщений от бота. [web:1][web:16]

---

## 12. Окружения и DevOps — MVP

Окружения:
- dev — локальная разработка (docker‑compose).
- staging — стенд (тестовый бот, Stripe sandbox).
- prod — боевое окружение. [conversation_history:0]

CI/CD:
- Линт и базовые проверки.
- Миграции БД.
- Сборка и деплой Docker‑контейнеров.

Secrets:
- Ключи Sonar, Stripe, Telegram, JWT — только через переменные окружения/secret manager. [web:1][web:16]

---

Этот BRIEF описывает функциональность первой версии (MVP) servAI — достаточную для полноценного запуска: жители и сотрудники работают через бот, УК и ЖК получают рабочую админ‑панель, платежи и базовый биллинг функционируют, а архитектура учитывает дальнейшее расширение (опросы, ворота, передача ЖК и т.д.).
