<template>
  <q-page padding>
    <div class="q-pa-md">
      <h5 class="q-my-none q-mb-md">{{ $t('nav.accessControl') }}</h5>
      <div class="row q-col-gutter-md q-mb-lg"><div class="col-12 col-sm-6 col-md-3"><q-card class="stat-card"><q-card-section><div class="stat-value text-primary">{{ stats.totalKeys }}</div><div class="stat-label">Active Keys</div></q-card-section></q-card></div><div class="col-12 col-sm-6 col-md-3"><q-card class="stat-card"><q-card-section><div class="stat-value text-positive">{{ stats.todayEntries }}</div><div class="stat-label">Today's Entries</div></q-card-section></q-card></div><div class="col-12 col-sm-6 col-md-3"><q-card class="stat-card"><q-card-section><div class="stat-value text-warning">{{ stats.guestPasses }}</div><div class="stat-label">Guest Passes</div></q-card-section></q-card></div><div class="col-12 col-sm-6 col-md-3"><q-card class="stat-card"><q-card-section><div class="stat-value text-negative">{{ stats.deniedAccess }}</div><div class="stat-label">Denied Access</div></q-card-section></q-card></div></div>
      <q-card class="q-mb-md"><q-card-section><div class="row items-center q-mb-md"><div class="col"><div class="text-h6">Access Keys</div></div><div class="col-auto"><q-btn color="primary" icon="add" label="Generate Key" @click="showKeyDialog = true" no-caps unelevated /></div></div><q-table :rows="accessKeys" :columns="keyColumns" row-key="id" :loading="loading" flat bordered><template v-slot:body-cell-type="props"><q-td :props="props"><q-badge :color="props.row.type === 'resident' ? 'primary' : 'secondary'" :label="props.row.type" /></q-td></template><template v-slot:body-cell-qrCode="props"><q-td :props="props"><q-btn flat round dense icon="qr_code" color="primary" @click="showQR(props.row)" /></q-td></template><template v-slot:body-cell-actions="props"><q-td :props="props"><q-btn flat round dense icon="delete" color="negative" @click="revokeKey(props.row.id)" /></q-td></template></q-table></q-card-section></q-card>
      <q-card><q-card-section><div class="text-h6 q-mb-md">Recent Access Log</div><q-table :rows="accessLog" :columns="logColumns" row-key="id" :loading="loading" flat bordered><template v-slot:body-cell-status="props"><q-td :props="props"><q-badge :color="props.row.status === 'granted' ? 'positive' : 'negative'" :label="props.row.status" /></q-td></template></q-table></q-card-section></q-card>
      <q-dialog v-model="showKeyDialog" persistent><q-card style="min-width: 500px"><q-card-section><div class="text-h6">Generate Access Key</div></q-card-section><q-card-section><q-form @submit="generateKey" class="q-gutter-md"><q-select v-model="newKey.type" :options="['resident', 'guest', 'worker', 'delivery']" label="Key Type *" outlined :rules="[val => !!val || 'Required']" /><q-select v-model="newKey.unitId" :options="units" option-value="id" option-label="unitNumber" label="Unit *" outlined emit-value map-options :rules="[val => !!val || 'Required']" /><q-input v-model="newKey.holderName" label="Holder Name *" outlined :rules="[val => !!val || 'Required']" /><q-input v-model="newKey.validFrom" label="Valid From" outlined type="date" /><q-input v-model="newKey.validUntil" label="Valid Until" outlined type="date" /><div class="row q-gutter-md justify-end"><q-btn flat label="Cancel" color="grey" v-close-popup /><q-btn type="submit" label="Generate" color="primary" :loading="generating" /></div></q-form></q-card-section></q-card></q-dialog>
    </div>
  </q-page>
</template>
<script>
import { defineComponent, ref, onMounted, computed } from 'vue'; import { useQuasar } from 'quasar'; import { accessControlAPI, unitsAPI } from '../../api';
export default defineComponent({ name: 'AccessControlOverviewPage', setup() { const $q = useQuasar(); const loading = ref(false), generating = ref(false), accessKeys = ref([]), accessLog = ref([]), units = ref([]), showKeyDialog = ref(false); const stats = ref({ totalKeys: 245, todayEntries: 89, guestPasses: 12, deniedAccess: 3 }); const newKey = ref({ type: 'resident', unitId: null, holderName: '', validFrom: '', validUntil: '' }); const keyColumns = computed(() => [{ name: 'keyCode', label: 'Key Code', field: 'keyCode', align: 'left' }, { name: 'type', label: 'Type', field: 'type', align: 'center' }, { name: 'holderName', label: 'Holder', field: 'holderName', align: 'left' }, { name: 'unit', label: 'Unit', field: row => row.unit?.unitNumber, align: 'left' }, { name: 'validUntil', label: 'Valid Until', field: 'validUntil', align: 'left', format: val => val ? new Date(val).toLocaleDateString() : 'Permanent' }, { name: 'qrCode', label: 'QR', field: 'qrCode', align: 'center' }, { name: 'actions', label: 'Actions', field: 'actions', align: 'center' }]); const logColumns = computed(() => [{ name: 'timestamp', label: 'Time', field: 'timestamp', align: 'left', format: val => new Date(val).toLocaleString() }, { name: 'holderName', label: 'Person', field: 'holderName', align: 'left' }, { name: 'unit', label: 'Unit', field: row => row.unit?.unitNumber, align: 'left' }, { name: 'action', label: 'Action', field: 'action', align: 'left' }, { name: 'status', label: 'Status', field: 'status', align: 'center' }]); const fetchData = async () => { loading.value = true; try { const [keysRes, logRes] = await Promise.all([accessControlAPI.getKeys(), accessControlAPI.getLog()]); accessKeys.value = keysRes.data.data || []; accessLog.value = logRes.data.data || []; } catch (error) { $q.notify({ message: error.message, color: 'negative', icon: 'error' }); } finally { loading.value = false; } }; const fetchUnits = async () => { try { const response = await unitsAPI.getAll({ limit: 100 }); units.value = response.data.data || []; } catch (error) { console.error('Failed', error); } }; const showQR = (key) => { $q.notify({ message: 'QR Code display coming soon', color: 'info' }); }; const revokeKey = async (id) => { try { await accessControlAPI.revokeKey(id); $q.notify({ message: 'Key revoked', color: 'positive', icon: 'check' }); await fetchData(); } catch (error) { $q.notify({ message: error.message, color: 'negative', icon: 'error' }); } }; const generateKey = async () => { generating.value = true; try { await accessControlAPI.generateKey(newKey.value); $q.notify({ message: 'Key generated successfully', color: 'positive', icon: 'check' }); showKeyDialog.value = false; newKey.value = { type: 'resident', unitId: null, holderName: '', validFrom: '', validUntil: '' }; await fetchData(); } catch (error) { $q.notify({ message: error.message, color: 'negative', icon: 'error' }); } finally { generating.value = false; } }; onMounted(() => { fetchData(); fetchUnits(); }); return { loading, generating, accessKeys, accessLog, units, stats, keyColumns, logColumns, showKeyDialog, newKey, showQR, revokeKey, generateKey }; } });
</script>
