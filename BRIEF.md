# BRIEF: servAI — AI‑платформа для управления многоквартирными комплексами

## 1. Общее описание продукта

servAI — это SaaS‑платформа для управляющих компаний (УК) и жилых комплексов (ЖК), в которой жители, сотрудники и администрация взаимодействуют через AI‑помощника в Telegram и веб‑админ‑панель. [web:1]

Основные элементы:
- Telegram‑бот для жителей и сотрудников (все сотрудники, кроме работы в админке, используют бота как основной инструмент).
- Админ‑панель (web, Vue3 + Quasar) для супер‑админа платформы, УК и администраторов ЖК.
- Бэкенд (Node.js + Express) с PostgreSQL, очередями (BullMQ) и интеграциями (Perplexity Sonar, Stripe, Telegram). [web:1]

Ключевые возможности:
- Естественное общение жителей с ботом (NLU через Perplexity Sonar, без ручных форм). [web:1][web:2]
- Показания счётчиков (ввод текстом и по фото, с AI‑распознаванием).
- Платежи жителей за услуги ЖК (Stripe), биллинг УК и комиссии платформы. [web:16][web:10]
- Обращения/заявки (тикеты) с AI‑категоризацией и автоназначением исполнителей.
- Опросы и голосования по подъезду и ЖК.
- Контроль въезда/ворот через охрану (машины, номера, разовые и постоянные пропуска).
- Отчётность для УК, ЖК и платформы.

Все данные разных УК логически изолированы (multi‑tenant, один общий кластер БД с tenant_id/uk_id в таблицах).  

---

## 2. Роли и иерархия

### 2.1. Уровни

- Платформа:
  - Супер‑админ платформы.
  - Супер‑бухгалтер платформы.
- Управляющая компания (УК):
  - Директор УК.
  - Бухгалтер УК.
- Жилой комплекс (ЖК):
  - Администратор ЖК.
  - Сотрудники ЖК (исполнители): сантехник, электрик, охранник, уборщик, садовник и т.п.
- Жители:
  - Владельцы и арендаторы, привязанные к объектам (квартирам/коммерческим помещениям).

Структура владения:
- Одна УК управляет одним или несколькими ЖК.
- Один ЖК принадлежит только одной УК.
- ЖК может быть передан от одной УК к другой (вся сущность ЖК переезжает целиком, кроме истории платежей УК).

Житель:
- Может быть привязан к нескольким объектам (квартирам/помещениям) в одном или нескольких ЖК и даже разных УК.
- Один объект может иметь несколько жителей (семья и т.п.).

Сотрудник:
- Может работать в нескольких ЖК в рамках одной или нескольких УК (например, приходящий электрик).

---

## 3. Telegram‑бот и AI

### 3.1. Общие принципы

- Бот один для всей платформы (один токен/бот), работает либо по webhook, либо по polling в зависимости от настроек деплоя. [web:15]
- Все жители и сотрудники работают через этого бота.
- Общение естественным языком, без жёстких команд меню.
- Язык ответа бота — язык пользователя из параметров Telegram (locale), без ручного выбора, но возможность выбрать язык может быть добавлена позже. [web:1]
- Вся история диалога хранится в БД, при обращении к Perplexity Sonar передаётся:
  - последние 20 сообщений диалога;
  - краткое резюме (summary) предыдущего общения (AI обязан возвращать обновлённое summary, которое сохраняется в БД).

### 3.2. Интеграция с Perplexity Sonar

- Используется Perplexity Sonar API (text‑модель с поиском, search‑first). [web:1][web:2][web:3]
- В системном промпте задаётся:
  - Роль бота (ассистент УК/ЖК).
  - Список доступных интентов и их структура.
  - Формат, в котором AI должен возвращать:
    - определённый интент;
    - параметры;
    - обновлённое summary пользователя.
- Системный промпт один на платформу и редактируется через админ‑панель (супер‑админ или специально предусмотренная настройка).

Все интенты (типы действий) настраиваются в админ‑панели:
- Список интентов (id, название, описание).
- Примеры пользовательских фраз.
- Ожидаемые параметры (тип, обязательность).
- Действие в системе (какой backend endpoint вызывать / какой доменный сценарий запускать).

### 3.3. Интенты (минимальный набор)

- Передача показаний счётчиков:
  - Ввод текстом.
  - Ввод по фото.
- Просмотр истории показаний.
- Создание обращения/тикета.
- Просмотр списка обращений и конкретного обращения.
- Комментирование обращения.
- Получение счета за период.
- Просмотр истории платежей.
- Участие в опросах (получение и голосование).
- Управление въездом автомобиля (разовый въезд, постоянный номер).
- Прочая справочная информация (FAQ, контакты УК/ЖК).

При неудачном определении интента бот отвечает, что не понял задачу, и просит переформулировать; прямой перевод на оператора не предусмотрен.

---

## 4. Структура объектов (ЖК, корпуса, подъезды, объекты)

### 4.1. Иерархия

- УК.
- ЖК:
  - Один или несколько корпусов (buildings).
  - В каждом корпусе — один или несколько подъездов (entrances).
  - В каждом подъезде — множество квартир и/или коммерческих помещений.
- Объекты:
  - Жилые квартиры.
  - Коммерческие помещения (могут быть привязаны или не привязаны к подъезду).
  - Тип объекта (жилое / нежилое / коммерческое / паркинг и т.п.) настраиваемый.

Номера:
- Номера квартир уникальны только в рамках корпуса.
- Подъезды могут нумероваться цифрами или буквами (строка).

Адрес объекта:
- Структура адреса включает: страна, город, улица, дом, корпус, подъезд, номер квартиры/помещения.
- Адрес хранится в объекте и используется в коммуникациях.

### 4.2. Импорт объектов

Импорт квартир/объектов через Excel:
- Обязательные поля:
  - Корпус.
  - Подъезд (может быть пустым для отдельных коммерческих помещений).
  - Номер объекта.
  - Этаж.
  - Площадь (>0, допускаются дробные значения, разделители «.» и «,»).
  - Тип объекта (жилое / нежилое / коммерческое и т.п.) — справочник типов в ЖК.
- Столбцы выбираются при загрузке:
  - Система пытается автоматически определить столбцы по заголовкам.
  - Администратор ЖК может вручную сопоставить столбцы.
- Импорт выполняется асинхронно и через очередь (BullMQ).
- При ошибках по отдельным строкам импорт не останавливается:
  - Ошибочные строки попадают в отчёт об ошибках.
  - Успешные — создаются/обновляются.
- Повторный импорт может обновлять данные существующих объектов (по ключу: корпус+подъезд+номер).

---

## 5. Пользователи, жители и сотрудники

### 5.1. Регистрация УК и суперадмин

- Регистрация УК возможна только супер‑админом платформы.
- Данные УК: как для юр. лица ЕС (название, регистрационный номер/ИНН, юр. адрес, страна, реквизиты, контакт директора и бухгалтера).
- Верификация документов не требуется.
- После создания УК директор УК получает доступ в админ‑панель.

Супер‑роли:
- Супер‑админ:
  - Управляет всеми УК, их настройками и ЖК.
  - Управляет глобальными настройками платформы (AI промпт, тарифы платформы, тех. настройки).
  - Имеет доступ на просмотр к данным всех УК/ЖК.
- Супер‑бухгалтер платформы:
  - Управляет счетами, выставляемыми платформой для УК.
  - Подтверждает оплаты от УК.
  - Может блокировать/разблокировать доступ УК в соответствии с оплатами.

### 5.2. Роли в УК и ЖК

- Директор УК:
  - Настройки УК.
  - Настройки всех ЖК в рамках УК.
  - Общая и пообъектная бухгалтерия.
  - Управление всеми сотрудниками УК и ЖК.
  - Настройки автоназначения задач.
  - Инициация передачи ЖК другой УК.
- Бухгалтер УК:
  - Бухгалтерия по всем ЖК.
  - Управление счетами по ЖК (начисления, платежи, отчёты).
- Администратор ЖК:
  - Настройки ЖК.
  - Бухгалтерия конкретного ЖК.
  - Управление очередью задач/обращений.
  - Управление сотрудниками конкретного ЖК.
  - Создание опросов.
- Сотрудники ЖК:
  - Сантехник, электрик, уборщик, садовник, охранник и т.п.
  - У каждого сотрудника — одна или несколько специализаций.
  - Сотрудник работает основным образом через Telegram‑бота.
  - У него есть список назначенных задач, статусы и возможность комментировать/прикладывать фото.

### 5.3. Жители

- Житель попадает в систему только через invite‑ссылку, которая привязана к конкретному объекту.
- Invite‑ссылки:
  - Генерируются администратором ЖК или УК.
  - Могут быть многоразовыми: по одной ссылке может зарегистрироваться несколько жителей одной квартиры/объекта.
  - Срок жизни ссылки — 7 дней (настраивается глобально в платформе).
  - В системе может задаваться лимит одновременно активных приглашений (по умолчанию 1 на объект).

При входе по invite в бота:
- Бот показывает предполагаемый адрес объекта.
- Если у жителя один объект — адрес выбирается автоматически.
- Если несколько — AI должен понять по контексту, к какому объекту относится запрос; при неуверенности бот уточняет у пользователя (список вариантов).

---

## 6. Обращения (тикеты)

### 6.1. Создание

- Житель формулирует проблему естественным текстом, при необходимости прикрепляет фото/файлы.
- AI:
  - Извлекает суть обращения.
  - Определяет категорию/тип обращения (из настраиваемого справочника).
  - Определяет объект (квартиру/помещение).
- Никаких ручных полей для жителя (тема, тип и т.д.) — всё вытаскивается AI.

Дополнительно:
- Охранник и другие сотрудники могут создавать обращения (например, об инцидентах) через бота.

### 6.2. Статусы и жизненный цикл

Статусы обращения:
1. Новое.
2. Назначено.
3. В работе.
4. Проверка.
5. Решено.
6. Закрыто.

Логика:
- При создании — статус «Новое».
- AI пытается автоматически назначить исполнителя на основе:
  - Категории обращения.
  - Специализаций сотрудников.
  - Доступности автоназначения (включено/выключено директором УК по категориям).
- Если AI назначил исполнителя:
  - Обращение переходит в статус «Назначено».
- Если директор УК не согласен с автоназначением (в админке):
  - Он может переназначить или отменить автоназначение.
  - Обращение попадает в очередь администратора ЖК для ручного назначения.
- Исполнитель через Telegram‑бот может:
  - Взять задачу в работу → статус «В работе».
  - Отправить на проверку → статус «Проверка».
  - Отметить как «Решено».
- После «Решено»:
  - Жителю отправляется запрос на оценку (1–5 звёзд).
  - Житель может оставить оценку и комментарий.
  - Через 24 часа после статуса «Решено» обращение автоматически закрывается, даже без оценки.  
    Статус → «Закрыто».

Житель:
- Может просматривать историю обращений.
- Может добавлять комментарии к своему обращению.
- Получает уведомления:
  - О назначении.
  - О переходе в работу.
  - О статусе «Решено» и запросе оценки.
  - О новых комментариях от УК/сотрудника.

### 6.3. Оценка и аналитика

- Оценки (1–5) привязаны к обращению и исполнителю.
- Отображаются:
  - Сотруднику (его средний рейтинг).
  - Администратору ЖК (по сотрудникам и категориям).
  - Директору УК (общая статистика по ЖК и сотрудникам).
- Житель оценки других жителей не видит.
- На первом этапе оценки не влияют на алгоритм автоназначения (только аналитика).

---

## 7. Показания счётчиков

### 7.1. Типы счётчиков

- По умолчанию в системе:
  - Холодная вода.
  - Электричество.
- УК/ЖК могут добавлять собственные типы счётчиков (горячая вода, отопление, газ, индивидуальные приборы и т.п.).
- Счётчики могут быть:
  - Однотарифные.
  - Многотарифные (например, день/ночь для электричества).

### 7.2. Ввод показаний

Житель может:
- Написать показания естественным текстом (в том числе: «холодная вода 123.4» и т.п.).
- Отправить фото счётчика.

AI:
- Для текста — извлекает тип счётчика и значение.
- Для фото:
  - Изображение отправляется в Perplexity Sonar с инструкцией распознать показания (без отдельного Vision API). [web:1][web:2]
  - Если распознать не удалось:
    - Первый раз — бот просит переснять.
    - Второй раз — снова просит переснять.
    - Если дважды не удалось распознать — бот предлагает ввести показания вручную.
  - Если распознано:
    - Бот показывает пользователю распознанное число.
    - Пользователь подтверждает или отклоняет и вводит вручную.

Валидация:
- Настраивается на уровне ЖК (предустановленные значения по умолчанию):
  - Новое показание >= предыдущего.
  - Допустимый максимум прироста за месяц (для каждого типа счётчика).
  - Значение > 0.
  - Дробные значения разрешены.
- При невалидности:
  - Бот просит ввести показания заново.
  - Если пользователь дважды вводит одно и то же значение, оно принимается (с отметкой о ручном принятии).

История:
- Житель может просматривать историю показаний.
- Фото и значения:
  - Сохраняются и доступны УК (администратору ЖК, директору) для проверок.
  - Фото хранятся в уменьшенном виде (например, 512×512) — достаточно для AI, без оригиналов.

---

## 8. Биллинг, тарифы и Stripe

### 8.1. Тарифы ЖК и начисления жителям

Тарифы задаются на уровне ЖК:
- Виды услуг:
  - Плата по показаниям счётчиков (вода, электричество и т.д.).
  - Плата по площади (например, обслуживание, охрана и т.д.).
  - Фиксированные платежи (абонентская плата).
- Для разных типов объектов (жилые, коммерческие и т.п.) могут быть разные тарифы за кв. м.
- Импорт объектов должен учитывать тип и площадь.

Начисление:
- Для каждого месяца для объекта формируется счет:
  - Составные части:
    - Показания × тариф.
    - Площадь × тариф.
    - Фиксированные платежи.
- Поведение при отсутствии показаний:
  - Логика начисления при отсутствии показаний настраивается в тарифах ЖК (по среднему, по предыдущему, по нормативу и т.п.).

### 8.2. Платежи жителей (Stripe)

- Житель получает от бота уведомление о сформированном счёте:
  - В Telegram — текстовое сообщение, по запросу — PDF‑счёт.
  - PDF формируется на стороне сервера, брендирование УК только в PDF (логотип, реквизиты и т.п.).
- Оплата:
  - Через Stripe Payment Link или аналогичный механизм. [web:10][web:19]
  - Оплата может быть частичной.
  - История платежей видна жителю по запросу.

Комиссия платформы:
- Настройки комиссии (фикс + процент) задаются в настройках платформы и/или конкретной УК.
- Комиссия удерживается до перевода средств УК (на стороне Stripe/бэкенда).
- В отчётах для УК отражается:
  - Сумма начислений.
  - Сумма оплат.
  - Сумма комиссии платформы.
  - Итог к выплате.

Stripe webhooks:
- Обрабатываются события:
  - Успешная оплата счета (invoice.paid / payment_intent.succeeded).
  - Неуспешные попытки оплаты (invoice.payment_failed / payment_intent.payment_failed).
- Обработка webhook идемпотентна (идентификатор события Stripe). [web:16][web:10]

### 8.3. Биллинг УК и оплата платформе

- УК оплачивает платформу на основании количества квартир/объектов (и/или логики, которую задаёт супер‑админ):
  - Точная стоимость за объект хранится в настройках платформы/УК.
- 1 числа каждого месяца:
  - Формируется счёт УК:
    - Сколько списано с жителей.
    - Сколько составляет комиссия платформы.
    - Сколько нужно доплатить/получить.
  - Счета в PDF генерируются автоматически и отправляются на email директора/бухгалтера УК.
  - PDF можно скачать из личного кабинета.
- Оплата сервисов платформы:
  - Списывается из платежей жителей (комиссии).
  - В случае задолженности УК:
    - Бот жителям отвечает, что УК не оплатила задолженность.
    - Доступ к админ‑панели блокируется, кроме личного кабинета и страницы счетов.
- Grace‑период:
  - 5 рабочих дней после 1 числа.
  - На 6‑й рабочий день, если супер‑бухгалтер платформы не подтвердил оплату, УК блокируется.

---

## 9. Опросы и голосования

### 9.1. Создание опросов

- Опросы создаёт администратор ЖК.
- Параметры опроса:
  - Текст вопроса.
  - Варианты ответа (список, с ограничением по количеству).
  - Тип выбора: одиночный / множественный.
  - Возможность вписать свой вариант (on/off).
  - Дедлайн.
  - Целевая аудитория:
    - Все жители ЖК.
    - Все жители конкретного подъезда.

Опросы создаются на одном языке, но:
- Все тексты опроса при отправке жителям переводятся на язык пользователя через AI.

### 9.2. Голосование

- Житель голосует в Telegram по кнопкам.
- Житель может изменить свой голос до дедлайна.
- Опросы анонимные:
  - Конкретные голоса не привязаны к личностям в отчётах для жителей.
  - В админке видна статистика по вариантам; детальная персональная информация может не требоваться.

Кворум:
- Настройки кворума задаются для каждого опроса.
- Может быть установлен в 0 (нет требований к минимальной явке).

Результаты:
- Доступны только после окончания опроса.
- Жителям показывается:
  - Количество голосов по каждому варианту.
- Администратор ЖК видит:
  - Полную статистику по опросу.

Уведомления:
- При создании опроса — всем жителям из целевой аудитории.
- Напоминания перед дедлайном — только тем, кто ещё не проголосовал.
- После закрытия — уведомление о результатах.

---

## 10. Контроль въезда (ворота/шлагбаум) и охрана

### 10.1. Роль охранника

- Охранник — специальный тип сотрудника ЖК.
- Работает через Telegram‑бота.
- Может быть несколько охранников на один ЖК (разные входы/смены).
- Основная функция — проверка номеров автомобилей и фиксация въездов.

### 10.2. Разовые пропуска

- Житель через бота сообщает:
  - Номер автомобиля, который приедет.
- Бот создаёт разовый пропуск:
  - Срок действия — сутки.
  - После суток заявка автоматически удаляется.
  - Житель может отменить заявку.

На въезде:
- Охранник вводит или фотографирует номер.
- AI сопоставляет номер с:
  - Разовыми пропусками.
  - Постоянными номерами.
- Если найден разовый пропуск в сроке действия:
  - Охраннику показывается, что машина принадлежит конкретной квартире/объекту.
  - Решение об открытии ворот принимает охранник (систем с физическим оборудованием нет).

Если номер не найден:
- Въезд не разрешается, решения о обходных сценариях (звонки и т.п.) в этой версии не реализуются.

### 10.3. Постоянные номера

- Для каждой квартиры/объекта может быть до 2 постоянных номеров (лимит настраивается на уровне ЖК).
- Житель может добавить/изменить постоянные номера через бота.
- При вводе/распознавании номера охранником:
  - Если номер совпадает с постоянным — охранник получает подтверждение, что этот номер закреплён за квартирой.

Валидация номеров:
- Номер — произвольный текст.
- Сравнение регистронезависимо.
- Пробелы игнорируются.

История въездов:
- Система логирует все проверки номеров и результат:
  - Для жителя:
    - История въездов его автомобилей.
  - Для администратора ЖК отдельной аналитики по въездам на данном этапе не требуется.

---

## 11. Уведомления и напоминания

### 11.1. Показания счётчиков

- Даты напоминаний задаются на уровне УК.
- Если житель уже передал показания в текущем месяце, повторные напоминания не отправляются.
- Количество напоминаний и логика (например, N раз в период) входят в настройки УК.

### 11.2. Счета и платежи

- Счета для жителей формируются 1 числа следующего месяца.
- Уведомление:
  - Сначала текст: «Ваш счёт готов», по запросу — PDF.
- Напоминания об неоплаченном счёте:
  - Раз в неделю, начиная через две недели после формирования счёта.

### 11.3. Обращения

- Житель получает уведомления:
  - При важных сменах статуса (назначено, в работе, проверка, решено).
  - При новых комментариях в обращении (от УК/сотрудников).

### 11.4. Системные уведомления

- Используются только для уведомлений о технических работах платформы (по решению супер‑админа).

Каналы:
- Telegram — основной.
- Email:
  - Регистрация новых пользователей (кроме сотрудников).
  - Отправка счетов УК от платформы.
  - Ежемесячные отчёты.
- SMS не используются.

---

## 12. Многоязычность и локализация

- В боте:
  - Полная локализация через AI.
  - Язык определяется по настройкам Telegram пользователя.
  - Сообщения УК/ЖК и системные тексты переводятся на язык пользователя.
- Опросы:
  - Создаются на одном языке.
  - При отправке жителям тексты переводятся на их языки.

Админ‑панель:
- Поддерживаемые языки: русский, английский, болгарский.
- Язык по умолчанию — из настроек браузера.
- Возможность сменить язык на экране входа.

Валюта:
- Настраивается на уровне УК (EUR, BGN, PLN, и т.д.).
- Формат дат и чисел:
  - Локализация форматов дат можно привязать к языку или стране УК.
  - Разделители чисел и дат должны соответствовать региональным стандартам.

---

## 13. Безопасность и GDPR

### 13.1. Аутентификация и токены

- Авторизация в админ‑панели — через email+пароль.
- JWT:
  - Access‑токен со сроком жизни 1 неделя.
  - Автообновление (refresh) раз в час (ре‑логин по backend‑механике, без выдачи отдельного refresh‑токена наружу).
- 2FA:
  - Через email.
  - Опционально, можно включить на аккаунте.

Требования к паролям:
- Минимальная длина/сложность.
- Смена по расписанию и истории паролей — не требуется на первом этапе.

### 13.2. GDPR и данные

- Платформа соответствует базовым требованиям GDPR.
- Согласие на обработку персональных данных:
  - Показывается пользователю при первом запуске бота.
  - Если пользователь продолжает пользоваться ботом, считается, что он согласен.
- Возможность удаления аккаунта и выгрузки персональных данных:
  - Должна быть предусмотрена архитектурно, но точный UX может быть реализован позже.

Хранение данных:
- Логи (audit log) и события — 3 месяца.
- Файлы (фото, вложения, PDF‑счета и т.п.) — удаляются через 1 год (PDF счёта для УК могут храниться до 3 лет, по решению платформы; в текущей версии — 3 года).
- Исторические показания счётчиков — не менее 12 месяцев.

### 13.3. Логирование и аудит

- Логируются:
  - Авторизации.
  - Все изменения данных (создание/редактирование/удаление сущностей).
  - Выполнение критичных операций (изменение настроек УК/ЖК, изменение ролей, передача ЖК).
- Доступ к аудит‑логам:
  - Супер‑админ (по всей платформе).
  - Директор УК (по своей УК/ЖК).

---

## 14. Файлы и медиа

- Хранилище:
  - Локальное (на сервере, в volume Docker).
  - Структура по УК/ЖК/датам.

Типы файлов:
- Фото счётчиков — масштабируются до 512×512 (или близко по площади), без потери информации для считывания.
- Фото от сотрудников — масштабируются до 2 Мп.
- Excel для импорта — не хранятся (после обработки удаляются).
- PDF‑счета — хранятся до 3 лет.
- Вложения к обращениям — только фото и PDF.

Обработка:
- Сжатие и оптимизация изображений.
- Генерация thumbnail'ов.
- Watermark не требуется.

Безопасность:
- Проверка типа файла (по содержимому, не только по расширению).
- Антивирусное сканирование не требуется на первой версии.
- Ссылки на приватные файлы — через backend, без прямого доступа из внешней сети.

Очистка:
- Файлы старше 1 года (кроме PDF‑счетов, если для них выбран больший срок) удаляются автоматически фоновыми задачами.

---

## 15. Миграция и передача ЖК между УК

- Передачу ЖК инициирует только директор отдающей УК.
- Процесс:
  1. Директор УК‑А выбирает ЖК и УК‑Б, которой передаётся ЖК.
  2. УК‑Б подтверждает (через административный интерфейс).
  3. ЖК полностью переносится под управление УК‑Б.

Передаётся:
- Вся информация по ЖК:
  - Объекты.
  - Жители и их связи с объектами.
  - История показаний.
  - Тарифы и настройки ЖК.
  - Обращения (открытые и закрытые).
  - Сотрудники ЖК.

Не передаётся:
- История платежей УК‑А платформе.

Незакрытые счета жителей:
- Переходят к новой УК (УК‑Б).

Уведомления:
- Жители получают уведомление о смене УК.
- Бот продолжает работать без изменений.
- Повторного GDPR‑согласия не требуется.

Откат:
- Передача необратима (отката нет).

---

## 16. Очереди и фоновые задачи

Используется BullMQ для фоновых задач.

Регулярные задачи (cron):

- 1 число месяца 00:01:
  - Подсчёт активных объектов/квартир.
  - Формирование счетов для жителей.
  - Формирование и отправка счетов УК.
  - Генерация ежемесячных отчётов (УК, ЖК, платформа).
- Ежедневно:
  - Очистка устаревших invite‑ссылок (старше 7 дней).
  - Очистка audit‑логов старше 3 месяцев.
  - Очистка файлов старше заданного срока.
- Напоминания:
  - О показаниях счётчиков в заданные даты.
  - Об оплате счетов.
  - Об опросах (к дедлайнам).

Файлы и вычислительные задачи:
- Импорт Excel (асинхронно).
- Генерация PDF.
- Рассылка массовых уведомлений (опросы, напоминания) с учётом rate‑limits Telegram. [web:15][web:18]

Нет ручного перезапуска задач через UI — система должна быть спроектирована так, чтобы задачи не зависали (ретраи, идемпотентность, мониторинг на уровне DevOps/инфраструктуры).

---

## 17. Отчётность и дашборды

### 17.1. Директор УК

Дашборд:
- Количество ЖК, объектов, активных жителей.
- Финансы:
  - Начисления и платежи по месяцам.
  - Задолженности.
  - Комиссия платформы.
- Обращения:
  - Количество открытых.
  - Среднее время решения.
- Рейтинги сотрудников.

Фильтры:
- По периоду.
- По ЖК.

Отчёты:
- Реестр объектов с показаниями.
- Начисления и платежи.
- Задолженности.
- Статистика обращений и оценок.

Форматы:
- Excel, PDF.
- Автоматическая рассылка 1 числа каждого месяца.

### 17.2. Администратор ЖК

Дашборд ЖК:
- Количество активных жителей и процент подключённых объектов.
- Сборы платежей (сколько собрано/начислено).
- Открытые обращения по категориям.
- График передачи показаний в текущем месяце.

---

## 18. API и интеграции (общая концепция)

Подробная структура эндпоинтов описана в openapi.yaml. Основные принципы:
- REST API, JSON‑формат.
- Версионирование: /api/v1/…
- Аутентификация:
  - JWT (Bearer).
  - Отдельные токены/ключи для веб‑клиента и сервисов (Telegram, Stripe webhooks и т.д.).
- Пагинация — курсорная (cursor, limit).
- Обработка Telegram‑обновлений:
  - Один webhook/endpoint для всех событий.
  - Обработка всех типов сообщений (text, photo, callback_query и т.д.).
- Stripe webhooks — строго по документации Stripe, с проверкой подписи, идемпотентностью. [web:16][web:19]

---

## 19. Нефункциональные требования (минимум)

- Производительность:
  - Оптимизация массовой рассылки в Telegram с учётом лимитов (примерно до 30 сообщений/сек на бота, с буферизацией через очередь). [web:15][web:18]
- Масштабируемость:
  - Возможность горизонтального масштабирования бэкенда.
  - Очереди и worker‑процессы.
- Логическая изоляция данных УК:
  - Все запросы пользователей и сотрудников всегда ограничены «своими» tenant/uk_id.
- Надёжность:
  - Идемпотентность webhooks.
  - Повтор задач очередей.
- Документация:
  - OpenAPI спецификация (openapi.yaml).
  - Swagger UI для разработчиков интеграций.

---

Этот BRIEF фиксирует согласованный функционал для реализации первой версии продукта (MVP+), с достаточной детализацией для разработки бэкенда, фронтенда и интеграций.
